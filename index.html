<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LB Navigator</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f5f5f5; color: #222; margin: 0; padding: 0; }
header { background-color: #111; color: white; padding: 1em; text-align: center; font-size: 1.5em; letter-spacing: 1px; }
main { padding: 1em 2em; }
textarea { width: 100%; height: 200px; display: none; }
button { background-color: #333; color: white; border: none; padding: 0.5em 1em; cursor: pointer; border-radius: 6px; margin: 0.2em; }
button:hover { background-color: #555; }
input { padding: 0.5em; margin: 0.2em 0; border-radius: 6px; border: 1px solid #ccc; width: 100%; display:block; }
#output { background-color: white; border-radius: 10px; padding: 1em; margin-top: 1em; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
.route-segment { margin: 0.5em 0; padding: 0.5em; border-left: 5px solid #333; background-color: #fafafa; border-radius:5px; }
.segment-line { font-weight:bold; color:white; padding:0.2em 0.5em; display:inline-block; border-radius:3px; margin-bottom:0.2em;}
.main-stop { margin-top:0.2em; font-weight:bold; }
.intermediate { font-size:0.9em; color:#555; margin-left:0.5em;}
.line-list { background: white; padding: 1em; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); margin-bottom: 1em; }
.line-group { margin-bottom: 1em; }
.line-group h4 { margin: 0.2em 0; cursor:pointer;}
.line-group ul { list-style-type: none; padding-left: 1em; margin: 0; display:none;}
</style>
</head>
<body>
<header>LB Navigator</header>
<main>
<h3>LinienÃ¼bersicht:</h3>
<div id="lineOverview"></div>

<label>Start: <input id="startStation" placeholder="z.B. Telnek"/></label>
<label>Ziel: <input id="endStation" placeholder="z.B. Revon"/></label>
<div style="display:flex; gap:0.5em; flex-wrap:wrap;">
<button onclick="findRoute()">Route finden</button>
<button onclick="findRoute(true)">Route (min. Umstiege)</button>
</div>
<div id="output"></div>

<textarea id="linesInput">{
  "lines":[
    {"id":"RB1","name":"RB1","stops":[{"station":"Telnek","platform":"1"},{"station":"Soul_Society(SÃ¼d)","platform":"1"},{"station":"Soul_Society(HBF)","platform":"2"},{"station":"LowlightHafen","platform":"1"},{"station":"Revon","platform":"1"}]},
    {"id":"SKB","name":"Selketalbahn (SKB)","stops":[{"station":"Soul_Society(HBF)","platform":"3"},{"station":"Soul_Society(OST)","platform":"1"},{"station":"Neustadt(West)","platform":"1"}]},
    {"id":"RB2","name":"RB2","stops":[{"station":"Soul_Society(HBF)","platform":"1"},{"station":"Soul_Society(Nord)","platform":"1"},{"station":"Heringsdorf Neuhof","platform":"1"},{"station":"Jungle Viadukt","platform":"1"}]}
  ]
}</textarea>

</main>
<script>
let network = {};
let lineColors = {RB1:'#d60000',RB2:'#ff0000',SKB:'#990000'};

function normalizeName(name){ return name.toLowerCase().replace(/\s+/g,'').replace(/_/g,''); }
function findStation(name){
  const norm=normalizeName(name);
  for(const station in network) if(normalizeName(station)===norm) return station;
  if(norm==='soulsociety') return 'Soul_Society(HBF)';
  return null;
}

function loadLines(){
  const data=JSON.parse(document.getElementById('linesInput').value);
  network={};
  for(const line of data.lines){
    for(let i=0;i<line.stops.length;i++){
      const stop=line.stops[i].station;
      if(!network[stop]) network[stop]=[];
      if(i>0){
        const prev=line.stops[i-1].station;
        network[stop].push({to:prev,line:line.id,platform:line.stops[i].platform});
        network[prev].push({to:stop,line:line.id,platform:line.stops[i-1].platform});
      }
    }
  }
  renderLineOverview(data.lines);
}

function renderLineOverview(lines){
  const groups={};
  for(const l of lines){
    const prefix=l.id.match(/^[A-Z]+/)[0];
    if(!groups[prefix]) groups[prefix]=[];
    groups[prefix].push(l);
  }
  const div=document.getElementById('lineOverview');
  div.innerHTML='';
  for(const prefix in groups){
    const g=document.createElement('div'); g.className='line-group';
    g.innerHTML=`<h4>ðŸš‰ ${prefix}-Linien</h4><ul>${groups[prefix].map(l=>`<li><b>${l.name}</b>: ${l.stops.map(s=>s.station).join(' â†’ ')}</li>`).join('')}</ul>`;
    div.appendChild(g);
    g.querySelector('h4').onclick=()=>{const ul=g.querySelector('ul');ul.style.display=ul.style.display==='none'?'block':'none';};
  }
}

function findRoute(minTransfers=false){
  const startInput=document.getElementById('startStation').value.trim();
  const endInput=document.getElementById('endStation').value.trim();
  const start=findStation(startInput), end=findStation(endInput);
  const out=document.getElementById('output');
  if(!start||!end){ out.innerHTML='<p>UngÃ¼ltige Station(en)!</p>'; return; }

  let queue=[{station:start,path:[],visited:new Set(),currentLine:null,transfers:0}];
  let best=null,visitedGlobal=new Set();
  while(queue.length){
    const cur=queue.shift();
    if(cur.station===end){ if(!best||(minTransfers?cur.transfers<best.transfers:cur.path.length<best.path.length)) best=cur; continue; }
    if(visitedGlobal.has(cur.station)) continue;
    visitedGlobal.add(cur.station);
    for(const next of network[cur.station]||[]){
      if(!cur.visited.has(next.to)){
        const newPath=cur.path.concat({from:cur.station,to:next.to,line:next.line,platformFrom:next.platform,platformTo:network[next.to].find(n=>n.to===cur.station).platform});
        const transfers=cur.currentLine&&cur.currentLine!==next.line?cur.transfers+1:cur.transfers;
        queue.push({station:next.to,path:newPath,visited:new Set([...cur.visited,cur.station]),currentLine:next.line,transfers});
      }
    }
  }

  if(!best){ out.innerHTML='<p>Keine Route gefunden!</p>'; return; }

  // Segmentieren fÃ¼r Umstiege/Gleiswechsel
  let segments=[],segStart=best.path[0].from,currentLine=best.path[0].line,intermediates=[];
  for(const step of best.path){
    if(step.line!==currentLine){
      segments.push({line:currentLine,from:segStart,to:step.from,intermediate:intermediates});
      segStart=step.from; currentLine=step.line; intermediates=[];
    }else intermediates.push(step.to);
  }
  segments.push({line:currentLine,from:segStart,to:best.path[best.path.length-1].to,intermediate:intermediates});

  out.innerHTML=`<h3>Route von ${start} nach ${end}</h3>`;
  for(const s of segments){
    const firstStep=best.path.find(p=>p.from===s.from&&p.line===s.line);
    const lastStep=best.path.slice().reverse().find(p=>p.to===s.to&&p.line===s.line);
    out.innerHTML+=`<div class="route-segment" style="border-color:${lineColors[s.line]}">`;
    out.innerHTML+=`<div class="segment-line" style="background:${lineColors[s.line]}">${s.line}</div>`;
    out.innerHTML+=`<div class="main-stop">${s.from} (Gleis ${firstStep.platformFrom}) â†’ ${s.to} (Gleis ${lastStep.platformTo})</div>`;
    if(s.intermediate.length>1){
      const mid=s.intermediate.slice(0,-1);
      if(mid.length>0) out.innerHTML+=`<div class="intermediate">Zwischenhalte: ${mid.join(', ')}</div>`;
    }
    if(firstStep.platformTo!==lastStep.platformFrom) out.innerHTML+=`<div class="intermediate" style="color:red">ðŸŸ¢ Umstieg in ${s.to} â€“ von Gleis ${firstStep.platformTo} auf Gleis ${lastStep.platformFrom}</div>`;
    out.innerHTML+='</div>';
  }
  out.innerHTML+=`<p><b>Umstiege:</b> ${best.transfers}</p>`;
}

window.onload=loadLines;
</script>
</body>
</html>