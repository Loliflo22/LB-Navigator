<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LB Navigator</title>

  <!-- Apple PWA Icon -->
  <link rel="apple-touch-icon" href="lb-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="LB Navigator" />

  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; color: #222; margin: 0; padding: 0; }
    header { background-color: #c00; color: white; padding: 1em; text-align: center; display:flex; align-items:center; justify-content:center; font-size: 1.5em; }
    .logo { background:white; color:#c00; font-weight:bold; font-size:1.2em; padding:0.2em 0.6em; margin-right:0.5em; border-radius:2px; }
    main { padding: 1em 2em; }
    input { width: 100%; padding:0.5em; margin:0.2em 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
    .button-row { display:flex; gap:0.5em; margin-top:0.5em; }
    button { background:#c00; color:white; border:none; padding:0.5em 1em; border-radius:6px; cursor:pointer; flex:1; }
    button:hover { background:#e33; }
    #output { background:white; border-radius:10px; padding:1em; margin-top:1em; box-shadow:0 0 5px rgba(0,0,0,0.2); }
    .route-segment { display:flex; flex-direction:column; margin:0.5em 0; padding:0.5em; border-left:6px solid; border-radius:4px; }
    .segment-line { font-weight:bold; margin-bottom:0.2em; padding:0.2em 0; border-radius:3px; color:white; text-align:center; width:60px; }
    .main-stop { font-weight:bold; }
    .intermediate { color:#999; font-size:0.9em; margin-left:1em; }
    .line-list { background:white; padding:1em; border-radius:10px; box-shadow:0 0 5px rgba(0,0,0,0.1); margin-bottom:1em; }
    .line-group { margin-bottom:1em; }
    .line-group h4 { margin:0.2em 0; color:#c00; cursor:pointer; user-select:none; }
    .line-group ul { list-style-type:none; padding-left:1em; margin:0; display:none; }
    .line-group.open ul { display:block; }
    textarea { display:none; }
  </style>
</head>
<body>
  <header>
    <div class="logo">LB</div>
    LB Navigator
  </header>
  <main>
    <h3>LinienÃ¼bersicht:</h3>
    <div id="lineOverview"></div>

    <label>Start:</label>
    <input id="startStation" placeholder="z.B. Telnek" />
    <label>Ziel:</label>
    <input id="endStation" placeholder="z.B. Revon" />

    <div class="button-row">
      <button onclick="findRoute()">Route finden</button>
      <button onclick="findRoute(true)">Route (min. Umstiege)</button>
    </div>

    <div id="output"></div>

    <textarea id="linesInput">{
      "lines": [
        {
          "id": "RB1",
          "name": "RB1",
          "stops": [
            {"station":"Telnek","platform":"1"},
            {"station":"Soul_Society(SÃ¼d)","platform":"1"},
            {"station":"Soul_Society(HBF)","platform":"2"},
            {"station":"LowlightHafen","platform":"1"},
            {"station":"Revon","platform":"1"}
          ]
        },
        {
          "id": "SKB",
          "name": "Selketalbahn (SKB)",
          "stops": [
            {"station":"Soul_Society(HBF)","platform":"3"},
            {"station":"Soul_Society(OST)","platform":"1"},
            {"station":"Neustadt(West)","platform":"1"}
          ]
        },
        {
          "id": "RB2",
          "name": "RB2",
          "stops": [
            {"station":"Soul_Society(HBF)","platform":"1"},
            {"station":"Soul_Society(Nord)","platform":"1"},
            {"station":"Heringsdorf","platform":"1"}
          ]
        },
        {
          "id": "RB3",
          "name": "RB3",
          "stops": [
            {"station":"Heringsdorf","platform":"2"},
            {"station":"Jungle Viadukt","platform":"1"},
            {"station":"Herrnburg","platform":"1"},
            {"station":"Puttgarden","platform":"1"}
          ]
        }
      ]
    }</textarea>
  </main>

  <script>
    let network = {};
    const lineColors = { "RB1":"#c00", "RB2":"#0077cc", "RB3":"#ff8800", "SKB":"#009933" };

    function normalizeName(name){ return name.toLowerCase().replace(/\s+/g,'').replace(/_/g,''); }
    function findStation(name){
      const n = normalizeName(name);
      for(const s in network)
        if(normalizeName(s)===n) return s;
      if(n==='soulsociety') return 'Soul_Society(HBF)';
      return null;
    }

    function loadLines(){
      const data = JSON.parse(document.getElementById('linesInput').value);
      network = {};
      for(const line of data.lines){
        for(let i=0;i<line.stops.length;i++){
          const stop = line.stops[i].station;
          if(!network[stop]) network[stop] = [];
          if(i>0){
            const prev = line.stops[i-1].station;
            network[stop].push({to:prev,line:line.id,platform:line.stops[i].platform});
            network[prev].push({to:stop,line:line.id,platform:line.stops[i-1].platform});
          }
        }
      }
      renderLineOverview(data.lines);
    }

    function renderLineOverview(lines){
      const groups = {};
      for(const l of lines){
        const prefix = l.id.match(/^[A-Z]+/)[0];
        if(!groups[prefix]) groups[prefix]=[];
        groups[prefix].push(l);
      }
      const div=document.getElementById('lineOverview');
      div.innerHTML='';
      for(const prefix in groups){
        const g=document.createElement('div'); g.className='line-group';
        g.innerHTML=`<h4>ðŸš‰ ${prefix}-Linien</h4><ul>${groups[prefix].map(l=>`<li><b>${l.name}</b>: ${l.stops.map(s=>s.station).join(' â†’ ')}</li>`).join('')}</ul>`;
        g.querySelector('h4').onclick=()=>g.classList.toggle('open');
        div.appendChild(g);
      }
    }

    function findRoute(minTransfers=false){
      const start = findStation(document.getElementById('startStation').value.trim());
      const end = findStation(document.getElementById('endStation').value.trim());
      const out = document.getElementById('output');
      if(!start || !end){ out.innerHTML='<p>UngÃ¼ltige Station(en)!</p>'; return; }

      let queue=[{station:start,path:[],visited:new Set(),currentLine:null,transfers:0}];
      let best=null;
      const visited=new Set();

      while(queue.length){
        const cur=queue.shift();
        if(cur.station===end){
          if(!best||(minTransfers?cur.transfers<best.transfers:cur.path.length<best.path.length)) best=cur;
          continue;
        }
        if(visited.has(cur.station)) continue;
        visited.add(cur.station);

        for(const next of network[cur.station]||[]){
          if(!cur.visited.has(next.to)){
            const newPath=cur.path.concat({from:cur.station,to:next.to,line:next.line,platform:next.platform});
            const transfers=cur.currentLine && cur.currentLine!==next.line ? cur.transfers+1 : cur.transfers;
            queue.push({station:next.to,path:newPath,visited:new Set([...cur.visited,cur.station]),currentLine:next.line,transfers});
          }
        }
      }

      if(!best){ out.innerHTML='<p>Keine Route gefunden!</p>'; return; }

      const segments=[];
      let segStart = best.path[0].from;
      let currentLine = best.path[0].line;
      let intermediates=[];

      for(let i=0;i<best.path.length;i++){
        const step=best.path[i];
        if(step.line!==currentLine){
          segments.push({line:currentLine,from:segStart,to:best.path[i-1].to,intermediate:intermediates});
          segStart=step.from; currentLine=step.line; intermediates=[];
        }else{ intermediates.push(step.to); }
      }
      segments.push({line:currentLine,from:segStart,to:best.path[best.path.length-1].to,intermediate:intermediates});

      out.innerHTML=`<h3>Route von ${start} nach ${end}</h3>`;
      for(const s of segments){
        const firstStep = best.path.find(p=>p.from===s.from && p.line===s.line);
        const lastStep = best.path.slice().reverse().find(p=>p.to===s.to && p.line===s.line);
        out.innerHTML+=`<div class="route-segment" style="border-color:${lineColors[s.line]}">`;
        out.innerHTML+=`<div class="segment-line" style="background:${lineColors[s.line]}">${s.line}</div>`;
        out.innerHTML+=`<div class="main-stop">${s.from} (Gleis ${firstStep.platform}) â†’ ${s.to} (Gleis ${lastStep.platform})</div>`;
        out.innerHTML+='</div>';
      }
    }

    window.onload=loadLines;
  </script>
</body>
</html>
